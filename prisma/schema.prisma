// Prisma Schema pour Da Vinci - Web-Autonomy Platform
// Générateur et configuration
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================================================
// ORGANISATIONS (Agences Web)
// ==============================================================================
model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique // ex: "mon-agence"

  // White-Label Branding
  brandingLogo      String?  // URL ou path du logo
  brandingColors    Json?    // { primary: "#6366f1", secondary: "#8b5cf6" }
  customDomain      String?  @unique // ex: "studio.mon-agence.com"

  // Subscription & Limits
  tier              AgencyTier @default(STARTER)
  plan              String   @default("free") // free, starter, pro, enterprise (legacy)
  maxProjects       Int      @default(3)
  maxUsers          Int      @default(5)
  maxStorageGB      Int      @default(5)
  maxClientsPerProject Int   @default(10)

  // Features enabled for this agency
  featuresEnabled   Json?    // { visualBuilder: true, aiAssistant: true, whiteLabel: false }

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users    User[]
  projects Project[]
  clients  Client[]
  templates ComponentTemplate[]
  assets   Asset[]

  @@index([slug])
  @@index([tier])
}

enum AgencyTier {
  STARTER       // 5 projets, 5 users, 10 GB
  PRO           // 25 projets, 25 users, 100 GB, white-label
  ENTERPRISE    // Illimité, support prioritaire, infra dédiée
}

// ==============================================================================
// UTILISATEURS
// ==============================================================================
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String
  role          UserRole @default(CLIENT_EDITOR)

  // Authentik SSO
  authentikId   String?  @unique  // ID externe depuis Authentik

  // Avatar
  avatarUrl     String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?

  @@index([email])
  @@index([organizationId])
  @@index([authentikId])
}

enum UserRole {
  SUPER_ADMIN      // Admin plateforme Da Vinci (niveau système)
  AGENCY_ADMIN     // Owner de l'agence (accès complet)
  AGENCY_DEVELOPER // Développeur de l'agence (mode Code activé)
  CLIENT_EDITOR    // Client final (mode Content/Design uniquement)
}

// ==============================================================================
// CLIENTS (Clients des agences)
// ==============================================================================
model Client {
  id          String   @id @default(uuid())
  name        String
  email       String
  company     String?
  phone       String?
  avatarUrl   String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Associated user account (optional - client peut ne pas avoir de compte)
  userId      String?  @unique

  // Projects this client has access to
  projectIds  String[] // Array of project IDs

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastAccessAt DateTime?

  @@index([organizationId])
  @@index([email])
}

// ==============================================================================
// PROJETS (Sites clients)
// ==============================================================================
model Project {
  id          String   @id @default(uuid())
  name        String
  slug        String   // ex: "mon-restaurant"

  // Infrastructure Docker/Coolify
  containerDockerId     String?   // ID Docker du conteneur
  coolifyProjectId      String?   // ID dans Coolify
  coolifyAppUuid        String?   @unique // UUID de l'application Coolify
  status                ProjectStatus @default(CREATING)

  // Domaines
  subdomain   String    // ex: "mon-restaurant.agence.com"
  customDomain String?  // ex: "www.monrestaurant.fr"

  // Git Repository
  gitRepository String?   // ex: "https://github.com/agence/mon-restaurant"
  gitBranch     String    @default("main")
  lastCommitHash String? // SHA du dernier commit

  // Template utilisé
  templateId  String    // ex: "master-astro-v1"

  // Métriques & Monitoring
  resourceUsageMB  Int   @default(512)    // RAM utilisée
  buildCount       Int   @default(0)      // Nombre de builds
  lastBuildStatus  String @default("never") // success, failed, building
  lastDeployedAt   DateTime?

  // Preview URLs (pour branches de dev)
  previewEnabled   Boolean @default(false)
  previewUrl       String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  deployments Deployment[]
  files       File[]
  pages       Page[]
  customComponents CustomComponent[]
  builderStates BuilderState[]
  analytics    Analytics[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([status])
  @@index([coolifyProjectId])
}

enum ProjectStatus {
  CREATING      // En cours de création (provisioning)
  BUILDING      // Build Docker en cours
  RUNNING       // Actif et accessible
  STOPPED       // Arrêté (hibernation)
  ERROR         // Erreur critique
  DELETED       // Marqué pour suppression
}

// ==============================================================================
// FICHIERS (Virtual File System)
// ==============================================================================
model File {
  id          String   @id @default(uuid())

  // File Info
  path        String   // Full path: /src/App.tsx
  name        String   // Filename: App.tsx
  type        String   // file or folder
  content     String?  @db.Text // File content (null for folders)
  language    String?  // typescript, javascript, css, etc.

  // Relations
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId      String   // Who owns/created this file

  // Metadata
  created     DateTime @default(now())
  modified    DateTime @updatedAt

  @@unique([projectId, path])
  @@index([projectId])
  @@index([userId])
  @@index([type])
}

// ==============================================================================
// PAGES (Visual Builder)
// ==============================================================================
model Page {
  id          String   @id @default(uuid())

  // Page Info
  title       String
  slug        String   // ex: "/", "/about", "/contact"
  path        String   // Full path in filesystem

  // Page Type
  type        PageType @default(STANDARD)

  // Builder Content (JSON structure of components)
  content     Json?    // { components: [...], layout: {...}, settings: {...} }

  // SEO
  metaTitle       String?
  metaDescription String?
  ogImage         String?

  // Settings
  isPublished Boolean @default(false)
  isDraft     Boolean @default(true)

  // Relations
  projectId   String
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Version History
  currentVersion Int @default(1)
  versions       PageVersion[]

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?
  createdBy   String   // User ID

  @@unique([projectId, slug])
  @@index([projectId])
  @@index([type])
  @@index([isPublished])
}

enum PageType {
  STANDARD      // Page standard
  HOME          // Page d'accueil
  BLOG_POST     // Article de blog
  PRODUCT       // Page produit
  LANDING       // Landing page
  CUSTOM        // Type personnalisé
}

// ==============================================================================
// PAGE VERSIONS (Historique et rollback)
// ==============================================================================
model PageVersion {
  id          String   @id @default(uuid())

  pageId      String
  page        Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  version     Int      // Version number (1, 2, 3...)
  content     Json     // Snapshot of page content

  // Metadata
  createdAt   DateTime @default(now())
  createdBy   String   // User ID
  comment     String?  // Optional commit message

  @@unique([pageId, version])
  @@index([pageId])
  @@index([createdAt])
}

// ==============================================================================
// COMPONENT TEMPLATES (Library de composants)
// ==============================================================================
model ComponentTemplate {
  id          String   @id @default(uuid())

  // Component Info
  name        String
  slug        String
  description String?
  category    ComponentCategory @default(CONTENT)

  // Component Code
  astroCode   String   @db.Text // Astro component source code
  propsSchema Json?    // JSON Schema for props validation

  // Preview
  thumbnail   String?
  previewUrl  String?

  // Availability
  isGlobal    Boolean @default(true)  // Available to all agencies
  isPremium   Boolean @default(false) // Requires PRO/ENTERPRISE tier

  // Relations
  organizationId String? // Null if global, agency ID if custom
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Usage stats
  usageCount  Int @default(0)

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  version     String @default("1.0.0")

  @@unique([slug, organizationId])
  @@index([category])
  @@index([isGlobal])
  @@index([isPremium])
}

enum ComponentCategory {
  LAYOUT        // Sections, Containers, Grid
  NAVIGATION    // Header, Footer, Menu, Breadcrumbs
  CONTENT       // Text, Image, Video, Gallery
  FORMS         // Input, Button, Form, Checkbox
  DATA          // Table, Chart, List
  INTERACTIVE   // Accordion, Tabs, Modal, Carousel
  ECOMMERCE     // Product, Cart, Checkout
  CUSTOM        // User-created
}

// ==============================================================================
// CUSTOM COMPONENTS (Composants créés par les utilisateurs)
// ==============================================================================
model CustomComponent {
  id          String   @id @default(uuid())

  // Component Info
  name        String
  slug        String
  description String?

  // Component Code
  astroCode   String   @db.Text
  cssCode     String?  @db.Text
  jsCode      String?  @db.Text
  propsSchema Json?

  // Relations
  projectId   String
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String   // User ID

  @@unique([projectId, slug])
  @@index([projectId])
}

// ==============================================================================
// ASSETS (Media Library)
// ==============================================================================
model Asset {
  id          String   @id @default(uuid())

  // File Info
  filename    String
  path        String   // Storage path (S3, local, etc.)
  url         String   // Public URL
  mimeType    String
  size        Int      // Size in bytes

  // Asset Type
  type        AssetType

  // Image-specific metadata
  width       Int?
  height      Int?
  altText     String?

  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  uploadedBy  String   // User ID

  @@index([organizationId])
  @@index([type])
  @@index([createdAt])
}

enum AssetType {
  IMAGE
  VIDEO
  DOCUMENT
  AUDIO
  FONT
  OTHER
}

// ==============================================================================
// ANALYTICS (Métriques et statistiques)
// ==============================================================================
model Analytics {
  id          String   @id @default(uuid())

  // Relations
  projectId   String
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Metrics
  pageViews   Int @default(0)
  uniqueVisitors Int @default(0)
  avgLoadTime Float? // Average page load time in ms

  // Traffic sources (JSON for flexibility)
  trafficSources Json? // { direct: 40, organic: 30, social: 20, referral: 10 }

  // Top pages
  topPages    Json? // [{ path: "/", views: 1000 }, ...]

  // Date range
  date        DateTime // Date for this analytics snapshot
  period      AnalyticsPeriod @default(DAY)

  // Metadata
  createdAt   DateTime @default(now())

  @@unique([projectId, date, period])
  @@index([projectId])
  @@index([date])
}

enum AnalyticsPeriod {
  HOUR
  DAY
  WEEK
  MONTH
}

// ==============================================================================
// BUILDER STATE (Sauvegarde état du visual builder)
// ==============================================================================
model BuilderState {
  id          String   @id @default(uuid())

  // Relations
  projectId   String
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId      String   // User who owns this state

  // State Data
  selectedComponentId String?  // Currently selected component
  zoom        Float @default(100) // Canvas zoom level
  viewportMode String @default("desktop") // desktop, tablet, mobile

  // Canvas position
  scrollX     Int @default(0)
  scrollY     Int @default(0)

  // Panels visibility
  panelsState Json? // { left: true, right: true, bottom: false }

  // Clipboard (for copy/paste)
  clipboard   Json?

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

// ==============================================================================
// DÉPLOIEMENTS (Historique des builds)
// ==============================================================================
model Deployment {
  id          String   @id @default(uuid())

  // Relations
  projectId   String
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Coolify Integration
  coolifyDeploymentUuid String? @unique // UUID du déploiement Coolify

  // Build Info
  commitSha   String?  // SHA du commit déployé
  commitMessage String?
  gitBranch   String   @default("main")
  buildNumber Int      @default(autoincrement()) // Numéro séquentiel du build

  // Status
  status      DeploymentStatus @default(pending)
  startedAt   DateTime?
  deployedAt  DateTime? // When successfully deployed
  finishedAt  DateTime?
  duration    Int?     // Durée en secondes

  // Logs & Errors
  buildLogs   String?  @db.Text  // Logs du build Docker
  error       String?  @db.Text  // Error message if failed

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([createdAt])
  @@index([coolifyDeploymentUuid])
}

enum DeploymentStatus {
  pending       // En attente dans la queue
  building      // Build en cours
  deployed      // Déployé avec succès
  failed        // Échec du déploiement
  cancelled     // Annulé par l'utilisateur
}

// ==============================================================================
// TEMPLATES (Master Themes)
// ==============================================================================
model Template {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique  // ex: "master-astro-restaurant"
  description String?
  thumbnail   String?  // URL de l'image de preview

  // Git Source
  sourceRepoUrl String  // ex: "https://github.com/davinci/master-astro"
  sourceBranch  String  @default("main")

  // Metadata
  category     String   // "restaurant", "portfolio", "ecommerce", "saas"
  tags         String[] // ["astro", "tailwind", "modern"]
  version      String   @default("1.0.0")
  isActive     Boolean  @default(true)
  isPremium    Boolean  @default(false)

  // Features
  hasKeystatic Boolean  @default(true)
  hasI18n      Boolean  @default(false)
  hasEcommerce Boolean  @default(false)

  // Usage Stats
  usageCount   Int      @default(0) // Nombre de projets créés avec ce template

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isActive])
}

// ==============================================================================
// ACTIVITÉS & LOGS (Audit Trail)
// ==============================================================================
model ActivityLog {
  id          String   @id @default(uuid())

  // Who
  userId      String
  userEmail   String

  // What
  action      String   // "project.created", "deployment.started", "user.invited"
  entityType  String   // "project", "deployment", "user"
  entityId    String
  changes     Json?    // Avant/Après pour les modifications

  // Context
  ipAddress   String?
  userAgent   String?

  // When
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
}
